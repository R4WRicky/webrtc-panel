<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel WebRTC Público</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em;
    }
    textarea {
      width: 90%;
      height: 180px;
      margin: 0.5em 0;
      background: #222;
      color: #0f0;
      border: 1px solid #444;
      resize: none;
    }
    button {
      margin: 0.5em;
      padding: 0.5em 1em;
      background: #444;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #666;
    }
    #status {
      margin-top: 1em;
      color: #0af;
    }
  </style>
</head>
<body>
  <h1>WebRTC Panel Público</h1>
  <p>1. Pega la oferta base64 del bot:</p>
  <textarea id="offer" placeholder="Oferta SDP en base64..."></textarea>
  <button onclick="generarRespuesta()">Generar Respuesta</button>
  <p>2. Copia y envía esta respuesta al bot:</p>
  <textarea id="answer" readonly></textarea>
  <div id="status">Esperando oferta...</div>

  <script>
    async function generarRespuesta() {
      const offerBase64 = document.getElementById("offer").value.trim();
      if (!offerBase64) {
        alert("Por favor, pega la oferta en base64.");
        return;
      }

      try {
        const sdp = atob(offerBase64);
        const offer = {
          type: "offer",
          sdp: sdp
        };

        const pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
          ]
        });

        pc.ontrack = (event) => {
          const stream = event.streams[0];
          const video = document.createElement("video");
          video.srcObject = stream;
          video.autoplay = true;
          video.controls = true;
          video.style.marginTop = "1em";
          document.body.appendChild(video);
        };

        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await new Promise(resolve => {
          if (pc.iceGatheringState === "complete") {
            resolve();
          } else {
            const checkState = () => {
              if (pc.iceGatheringState === "complete") {
                pc.removeEventListener("icegatheringstatechange", checkState);
                resolve();
              }
            };
            pc.addEventListener("icegatheringstatechange", checkState);
          }
        });

        const answerBase64 = btoa(pc.localDescription.sdp);
        document.getElementById("answer").value = answerBase64;
        document.getElementById("status").textContent = "Respuesta generada correctamente.";
      } catch (error) {
        document.getElementById("status").textContent = "Error generando la respuesta.";
        console.error(error);
      }
    }
  </script>
</body>
</html>
